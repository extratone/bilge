!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t=t||self).CRDT={})}(this,(function(t){"use strict";const e={"\x04":-1,"\x05":1,"\x06":-1},i={"\x04":"\x05","\x05":"\x06","\x06":"\x05"},n={"\x04":"\x06","\x05":"\x05","\x06":"\x06"},r="0".charCodeAt(0),a="\ud7ff".charCodeAt(0)-r+1,s=a*a,l=s-1;function o(t){if("\x01"!==t.type)return"";let i=0;for(let n=0;n<t.modifiers.length;n++)i+=e[t.modifiers[n].type];return i>=0?t.payload:""}function d(t,i){if("\x01"!==t.type)return"";if(t.timestamp>i)return"";let n=0;for(let r=0;r<t.modifiers.length;r++){let a=t.modifiers[r];a.timestamp<=i&&(n+=e[a.type])}return n>=0?t.payload:""}function f(t,i){if("\x01"!==t.type)return"";let n=t.payload,r=i[t.clientId];if(void 0===r||r<t.firstOrdinal)return"";if(r<t.lastOrdinal){let e=r-t.firstOrdinal+1;n=n.slice(0,e)}let a={};for(let n=0;n<t.modifiers.length;n++){const r=t.modifiers[n];let s=i[r.clientId];if(void 0!==s&&s>=r.firstOrdinal){let t=Math.max(0,r.lastOrdinal-s);a[t]=void 0!==a[t]?a[t]+e[r.type]:e[r.type]}}let s=0,l=!0,o=Object.keys(a).map(Number).sort().reduce((t,e)=>(l&&(t+=n.slice(s,e)),s=e,l=a[e]>=0,t),"");return l&&(o+=n.slice(s)),o}function h(t,e){return t.segment.clientId===e.segment.clientId&&t.ordinal===e.ordinal}function c(t){if(t.firstChild)return t.firstChild;let e=t;for(;e;){if(e.nextSibling)return e.nextSibling;e=e.parent}}function p(t){if(t.previousSibling){let e=t.previousSibling;for(;e.lastChild;)e=e.lastChild;return e}return t.parent}function u(t){if(t.lastChild)return t.lastChild;let e=t;for(;e;){if(e.previousSibling)return e.previousSibling;e=e.parent}}function g(t){if(t.ordinal<t.segment.lastOrdinal)return{segment:t.segment,ordinal:t.ordinal+1};let e=c(t.segment);return void 0!==e?{segment:e,ordinal:e.firstOrdinal}:void 0}function m(t){if(t.ordinal>t.segment.firstOrdinal)return{segment:t.segment,ordinal:t.ordinal-1};let e=p(t.segment);return void 0!==e?{segment:e,ordinal:e.lastOrdinal}:void 0}function v(t,e,i){let n=t;for(;n;){if(e===n.clientId&&i>=n.firstOrdinal&&i<=n.lastOrdinal)return{segment:n,ordinal:i};n=c(n)}}function I(t,e,i){let n=t;for(;n;){if(e===n.clientId&&i>=n.firstOrdinal&&i<=n.lastOrdinal)return{segment:n,ordinal:i};n=p(n)}}function _(t,e){if(e<0)throw"Offset out of range.";if("\x03"===t.segment.type)throw"The end delimiter is not a valid position";if(0===e)return t;let i,n;for("\x02"===t.segment.type?(i=c(t.segment),n=0):(i=t.segment,n=-(t.ordinal-t.segment.firstOrdinal+1));i;){let t=o(i);if(n+t.length>=e){return{segment:i,ordinal:i.firstOrdinal+(e-n)-1}}n+=t.length,i=c(i)}throw"Offset out of range."}function O(t,e,i){let n=0,r=t;for(;r;){let t=void 0===i?o(r):f(r,i);if(r===e.segment)return"\x01"===r.type&&(n+=Math.min(t.length,e.ordinal-r.firstOrdinal+1)),n;n+=t.length,r=c(r)}throw"Expected to find the position in weave."}function b(t,e,i){if(void 0!==t.parent)throw"Expected reduce to be called on root";var n=i;let r=t;for(;r;)n=e(n,r),r=c(r);return n}function E(t,e,i){if(void 0!==t.parent)throw"Expected reduce to be called on root";var n=i;let r=t;for(;r;){n=e(n,r,r.parent);for(let t=0;t<r.modifiers.length;t++){n=e(n,r.modifiers[t],r)}r=c(r)}return n}const y=/(?:([\x02-\x06])([^][^][^])([^][^])([^][^])([^][^][^])([^][^])([^][^])([^][^][^])([^\x00-\x09]*))/g,F=/(?:(\x01)([^][^][^])([^][^])([^][^])([^][^][^])([^][^])([^][^])([^][^][^])([^\x00]+)\x00)/g,x=/(?:\x08([^][^][^])([^\x00]+)\x00)/g,D=new RegExp(`(?:${/(?:\x09(?:([^][^][^])([^][^]))?)/g.source}${F.source}|${/(?:([\x04-\x06])([^][^][^])([^][^])([^][^])([^][^][^])([^][^])([^][^])([^][^][^]))/g.source})`,"g");class w{constructor(t){this.currentIndex=0,this.text=t}matchOptional(t){if(!t.global)throw"Missing global flag.";t.lastIndex=this.currentIndex;let e=t.exec(this.text);return null===e||e.index!==this.currentIndex?null:(this.currentIndex+=e[0].length,e)}matchRequired(t,e){let i=this.matchOptional(t);if(null===i)throw`Expecting to find ${e} at index ${this.currentIndex} when parsing.`;return i}matchEnd(){if(this.currentIndex!==this.text.length)throw"Unexpected end when parsing."}}function T(...t){let e=new w(t.join("")),i=U(e),n=C(e);return e.matchEnd(),{userDictionary:i,segmentTreeRoot:n}}function S(t){return M(t.userDictionary)+function(t){if(void 0!==t.parent)throw"Expecting to get the root segment when encoding weave.";return E(t,(t,e,i)=>{var n,r;return t+R(e.type,e.clientId,e.firstOrdinal,e.lastOrdinal,null!==(n=null==i?void 0:i.clientId)&&void 0!==n?n:e.clientId,null!==(r=null==i?void 0:i.lastOrdinal)&&void 0!==r?r:e.lastOrdinal,e.timestamp,e.userId,e.payload)},"")}(t.segmentTreeRoot)}function C(t,e){var i;let n,r;var a=[];let s;for(;s=t.matchOptional(F)||t.matchOptional(y);){let[,i,l,o,d,f,h,c,p,u]=s,g=k(o),m=k(d),v=k(h),I=k(c);if(a.push([l,g,m]),void 0!==e&&void 0===e[p])throw`Couldn't find user id in user dictionary (${p})`;switch(i){case"\x01":{let t={type:i,clientId:l,firstOrdinal:g,lastOrdinal:m,timestamp:I,userId:p,payload:u,parent:void 0,firstChild:void 0,lastChild:void 0,nextSibling:void 0,previousSibling:void 0,modifiers:[]};for(;r&&(r.clientId!==f||r.lastOrdinal!==v);)r=r.parent;if(void 0===r)throw`Expected to find a parent to insert brief (${$(t)}).`;if(t.payload.length!==t.lastOrdinal-t.firstOrdinal+1)throw`Expected insert brief atom count to match payload length (${$(t)}).`;t.parent=r,void 0===r.lastChild?(r.firstChild=t,r.lastChild=t):(r.lastChild.nextSibling=t,t.previousSibling=r.lastChild,r.lastChild=t),r=t}break;case"\x04":case"\x05":case"\x06":{let t={type:i,clientId:l,firstOrdinal:g,lastOrdinal:m,timestamp:I,userId:p,payload:u};if(!r||r.clientId!==f||r.lastOrdinal!==v)throw`Expected modifier to have its parent next to it (${$(t)}).`;if("\x01"!==r.type)throw`Expected modifier to have a parent of insert type (${$(t)}).`;if(r.lastOrdinal-r.firstOrdinal!=t.lastOrdinal-t.firstOrdinal)throw`Expected modifier to have same number of atoms as its parent (${$(t)}).`;if(""!==t.payload)throw`Expected modifier to have empty payload (${$(t)}).`;r.modifiers.push(t)}break;case"\x02":{let t={type:i,clientId:l,firstOrdinal:g,lastOrdinal:m,timestamp:I,userId:p,payload:u,parent:void 0,firstChild:void 0,lastChild:void 0,nextSibling:void 0,previousSibling:void 0,modifiers:[]};if(void 0!==n)throw`Expected start delimiter only in first position (${$(t)}).`;if(t.firstOrdinal!==t.lastOrdinal)throw`Expected start delimiter to only have one atom (${$(t)}).`;if(3!==t.payload.length)throw`Expected start delimiter to have a weave id of length 3 (${$(t)}).`;n=t,r=n}break;case"\x03":{let e={type:i,clientId:l,firstOrdinal:g,lastOrdinal:m,timestamp:I,userId:p,payload:u,parent:n,firstChild:void 0,lastChild:void 0,nextSibling:void 0,previousSibling:void 0,modifiers:[]};if(void 0===n||s.index+s[0].length!==t.text.length)throw`Expected end delimiter only at the last position (${$(e)}).`;if(n.clientId!==f||n.lastOrdinal!==v)throw`Expected end delimiter to have root as a parent (${$(e)}).`;if(e.firstOrdinal!==e.lastOrdinal)throw`Expected end delimiter to only have one atom (${$(e)}).`;if(""!==e.payload)throw`Expected end delimiter to have empty payload (${$(e)}).`;void 0===n.lastChild?(n.firstChild=e,n.lastChild=e):(n.lastChild.nextSibling=e,e.previousSibling=n.lastChild,n.lastChild=e)}}}if(void 0===n)throw"Didn't find any briefs";if("\x03"!==(null===(i=n.lastChild)||void 0===i?void 0:i.type))throw"Expected to find an end delimiter";var l,o,d;a.sort((t,e)=>t[0]===e[0]?t[1]-e[1]:t[0]<e[0]?-1:1);for(let t=0;t<a.length;t++){const[e,i,n]=a[t];if(e!==l){if(0!==i)throw`Expected to have first ordinal of client to be zero (${e}.${i}.${n}).`}else if(o&&d&&i!==d+1)throw`Expecting non overlapping consecutive ids (${l}.${o}.${d}, ${e}.${i}.${n})`;l=e,o=i,d=n}return n}function R(t,e,i,n,r,a,s,l,o=""){if("\x01"===t&&""===o)return"";return[t,e,N(i),N(n),r,N(a),N(s),l,o,"\x01"===t?"\0":""].join("")}function A(t){let e=M(t.userDictionary);return t.briefs.forEach(t=>{if("\x01"===t.type){let i=t.insertBeforeClientId,n=t.insertBeforeOrdinal;e+="\t",void 0!==i&&void 0!==n&&(e+=`${i}${N(n)}`),e+=R(t.type,t.clientId,t.firstOrdinal,t.lastOrdinal,t.parentClientId,t.parentOrdinal,t.timestamp,t.userId,t.payload)}else e+=R(t.type,t.clientId,t.firstOrdinal,t.lastOrdinal,t.parentClientId,t.parentOrdinal,t.timestamp,t.userId,t.payload)}),e}function L(...t){let e=new w(t.join("")),i=U(e),n=function(t,e){let i,n=[];for(;i=t.matchOptional(D);){let t;if(t="\x01"===i[3]?{insertBeforeClientId:i[1],insertBeforeOrdinal:void 0!==i[2]?k(i[2]):void 0,type:i[3],clientId:i[4],firstOrdinal:k(i[5]),lastOrdinal:k(i[6]),parentClientId:i[7],parentOrdinal:k(i[8]),timestamp:k(i[9]),userId:i[10],payload:i[11]}:{type:i[12],clientId:i[13],firstOrdinal:k(i[14]),lastOrdinal:k(i[15]),parentClientId:i[16],parentOrdinal:k(i[17]),timestamp:k(i[18]),userId:i[19],payload:""},void 0===e[t.userId])throw`Could not find user id in user dictionary (${t.userId})`;n.push(t)}return n}(e,i);return e.matchEnd(),{userDictionary:i,briefs:n}}function M(t){return Object.keys(t).sort().map(e=>"\b"+e+t[e]+"\0").join("")}function U(t){let e,i={};for(;e=t.matchOptional(x);)i[e[1]]=e[2];return i}function N(t){if(t<0||t>=s)throw`encodeDuplet: Number out of range "${t}"`;const e=Math.floor(t/a)+r,i=t%a+r;return String.fromCharCode(e)+String.fromCharCode(i)}function k(t){if(2!==t.length)throw`decodeDouble: Unexpected length of string "${t}"`;const e=t.charCodeAt(0)-r,i=t.charCodeAt(1)-r;return e*a+i}function $(t){return`${t.clientId}.${t.firstOrdinal}`}function Q(){return String.fromCharCode(r+Math.floor(Math.random()*Math.floor(a)),r+Math.floor(Math.random()*Math.floor(a)),r+Math.floor(Math.random()*Math.floor(a)))}function j(t,e,i,n){let r=void 0===i;return b(t,(t,a)=>{let s=d(a,e=null!=e?e:l);if((null==i?void 0:i.segment)===a){if((null==n?void 0:n.segment)===a){let e=i.ordinal-a.firstOrdinal+1,r=n.ordinal-a.firstOrdinal+1;return t+s.slice(e,r)}{r=!0;let e=i.ordinal-a.firstOrdinal+1;return t+s.slice(e)}}if((null==n?void 0:n.segment)===a){r=!1;let e=n.ordinal-a.firstOrdinal+1;return t+s.slice(0,e)}return r?t+s:t},"")}function B(t,e,i){let n=d(t,e-1),r=d(t,i);if(""===n&&""===r)return;if(""!==n&&""!==r)return"present";let a=t.timestamp,s=t.userId;return t.modifiers.forEach(t=>{t.timestamp>a&&t.timestamp<=i&&(a=t.timestamp,s=t.userId)}),""===n&&""!==r?["added",s]:["removed",s]}function P(t){return E(t,(t,e,i)=>{let n=t[e.clientId];return(void 0===n||n<e.lastOrdinal)&&(t[e.clientId]=e.lastOrdinal),t},{})}function z(t,e,i,n){for(let e=t.length-1;e>0;e--){const i=2*(n-1),r=t[e],a=r[i];if(" "!==a){if("\u2514"===a){t[e]=r.substring(0,i)+"\u251c"+r.substring(i+1);break}break}t[e]=r.substring(0,i)+"\u2502"+r.substring(i+1)}var r="";switch(n>1&&(r="  ".repeat(n-1)),n>0&&(r+="\u2514\u2500"),e.type){case"\x02":r+="STA";break;case"\x03":r+="END";break;case"\x04":r+="DEL";break;case"\x05":r+="UIN";break;case"\x06":r+="UDE";break;case"\x01":r+="INS";break;default:throw"Expected to see known type."}r+=" ",r+=e.clientId,r+=".",r+=e.firstOrdinal,r+=".",r+=e.lastOrdinal,r+=" ",r+=i.clientId,r+=".",r+=i.lastOrdinal,r+=" ",r+=e.timestamp,r+=" ",r+=e.userId,""!==e.payload&&(r+=" ",r+=e.payload),r+="\n",t.push(r)}var q,G=/[^a-zA-Z0-9]/,H=/\s/,V=/[\r\n]/,X=/\n\r?\n$/,Z=/^\r?\n\r?\n/;!function(t){t[t.DIFF_DELETE=-1]="DIFF_DELETE",t[t.DIFF_INSERT=1]="DIFF_INSERT",t[t.DIFF_EQUAL=0]="DIFF_EQUAL"}(q||(q={}));var J=Object.freeze({__proto__:null,min:function(t,e){return t<e?t:e},max:function(t,e){return t>e?t:e}}),K=function(){function t(){this.diffs=[],this.start1=0,this.start2=0,this.length1=0,this.length2=0}return t.prototype.toString=function(){for(var t,e=["@@ -"+(0===this.length1?this.start1+",0":1===this.length1?this.start1+1:this.start1+1+","+this.length1)+" +"+(0===this.length2?this.start2+",0":1===this.length2?this.start2+1:this.start2+1+","+this.length2)+" @@\n"],i=0;i<this.diffs.length;i++){switch(this.diffs[i][0]){case q.DIFF_INSERT:t="+";break;case q.DIFF_DELETE:t="-";break;case q.DIFF_EQUAL:t=" "}e[i+1]=t+encodeURI(this.diffs[i][1])+"\n"}return e.join("").replace(/%20/g," ")},t}(),W=function(){function t(){this.diffTimeout=1,this.diffEditCost=4,this.matchThreshold=.5,this.matchDistance=1e3,this.patchDeleteThreshold=.5,this.patchMargin=4,this.matchMaxBits=32}return t.prototype.diff_main=function(t,e,i,n){void 0===n&&(n=this.diffTimeout<=0?Number.MAX_VALUE:Date.now()+1e3*this.diffTimeout);var r=n;if(null==t||null==e)throw new Error("Null input. (diff_main)");if(t===e)return t?[[q.DIFF_EQUAL,t]]:[];void 0===i&&(i=!0);var a=i,s=this.diff_commonPrefix(t,e),l=t.substring(0,s);t=t.substring(s),e=e.substring(s),s=this.diff_commonSuffix(t,e);var o=t.substring(t.length-s);t=t.substring(0,t.length-s),e=e.substring(0,e.length-s);var d=this.diff_compute_(t,e,a,r);return l&&d.unshift([q.DIFF_EQUAL,l]),o&&d.push([q.DIFF_EQUAL,o]),this.diff_cleanupMerge(d),d},t.prototype.diff_commonPrefix=function(t,e){if(!t||!e||t.charAt(0)!==e.charAt(0))return 0;for(var i=0,n=J.min(t.length,e.length),r=n,a=0;i<r;)t.substring(a,r)===e.substring(a,r)?a=i=r:n=r,r=Math.floor((n-i)/2+i);return r},t.prototype.diff_commonSuffix=function(t,e){if(!t||!e||t.charAt(t.length-1)!==e.charAt(e.length-1))return 0;for(var i=0,n=J.min(t.length,e.length),r=n,a=0;i<r;)t.substring(t.length-r,t.length-a)===e.substring(e.length-r,e.length-a)?a=i=r:n=r,r=Math.floor((n-i)/2+i);return r},t.prototype.diff_cleanupSemantic=function(t){for(var e=!1,i=[],n=0,r=null,a=0,s=0,l=0,o=0,d=0;a<t.length;)t[a][0]===q.DIFF_EQUAL?(i[n++]=a,s=o,l=d,o=0,d=0,r=t[a][1]):(t[a][0]===q.DIFF_INSERT?o+=t[a][1].length:d+=t[a][1].length,r&&r.length<=J.max(s,l)&&r.length<=J.max(o,d)&&(t.splice(i[n-1],0,[q.DIFF_DELETE,r]),t[i[n-1]+1][0]=q.DIFF_INSERT,n--,a=--n>0?i[n-1]:-1,s=0,l=0,o=0,d=0,r=null,e=!0)),a++;for(e&&this.diff_cleanupMerge(t),this.diff_cleanupSemanticLossless(t),a=1;a<t.length;){if(t[a-1][0]===q.DIFF_DELETE&&t[a][0]===q.DIFF_INSERT){var f=t[a-1][1],h=t[a][1],c=this.diff_commonOverlap_(f,h),p=this.diff_commonOverlap_(h,f);c>=p?(c>=f.length/2||c>=h.length/2)&&(t.splice(a,0,[q.DIFF_EQUAL,h.substring(0,c)]),t[a-1][1]=f.substring(0,f.length-c),t[a+1][1]=h.substring(c),a++):(p>=f.length/2||p>=h.length/2)&&(t.splice(a,0,[q.DIFF_EQUAL,f.substring(0,p)]),t[a-1][0]=q.DIFF_INSERT,t[a-1][1]=h.substring(0,h.length-p),t[a+1][0]=q.DIFF_DELETE,t[a+1][1]=f.substring(p),a++),a++}a++}},t.prototype.diff_cleanupSemanticLossless=function(t){for(var e=1;e<t.length-1;){if(t[e-1][0]===q.DIFF_EQUAL&&t[e+1][0]===q.DIFF_EQUAL){var i=t[e-1][1],n=t[e][1],r=t[e+1][1],a=this.diff_commonSuffix(i,n);if(a){var s=n.substring(n.length-a);i=i.substring(0,i.length-a),n=s+n.substring(0,n.length-a),r=s+r}for(var l=i,o=n,d=r,f=this.diff_cleanupSemanticScore_(i,n)+this.diff_cleanupSemanticScore_(n,r);n.charAt(0)===r.charAt(0);){i+=n.charAt(0),n=n.substring(1)+r.charAt(0),r=r.substring(1);var h=this.diff_cleanupSemanticScore_(i,n)+this.diff_cleanupSemanticScore_(n,r);h>=f&&(f=h,l=i,o=n,d=r)}t[e-1][1]!==l&&(l?t[e-1][1]=l:(t.splice(e-1,1),e--),t[e][1]=o,d?t[e+1][1]=d:(t.splice(e+1,1),e--))}e++}},t.prototype.diff_cleanupEfficiency=function(t){for(var e=!1,i=[],n=0,r=null,a=0,s=!1,l=!1,o=!1,d=!1;a<t.length;)t[a][0]===q.DIFF_EQUAL?(t[a][1].length<this.diffEditCost&&(o||d)?(i[n++]=a,s=o,l=d,r=t[a][1]):(n=0,r=null),o=d=!1):(t[a][0]===q.DIFF_DELETE?d=!0:o=!0,r&&(s&&l&&o&&d||r.length<this.diffEditCost/2&&Number(s)+Number(l)+Number(o)+Number(d)===3)&&(t.splice(i[n-1],0,[q.DIFF_DELETE,r]),t[i[n-1]+1][0]=q.DIFF_INSERT,n--,r=null,s&&l?(o=d=!0,n=0):(a=--n>0?i[n-1]:-1,o=d=!1),e=!0)),a++;e&&this.diff_cleanupMerge(t)},t.prototype.diff_cleanupMerge=function(t){t.push([q.DIFF_EQUAL,""]);for(var e,i=0,n=0,r=0,a="",s="";i<t.length;)switch(t[i][0]){case q.DIFF_INSERT:r++,s+=t[i][1],i++;break;case q.DIFF_DELETE:n++,a+=t[i][1],i++;break;case q.DIFF_EQUAL:n+r>1?(0!==n&&0!==r&&(0!==(e=this.diff_commonPrefix(s,a))&&(i-n-r>0&&t[i-n-r-1][0]===q.DIFF_EQUAL?t[i-n-r-1][1]+=s.substring(0,e):(t.splice(0,0,[q.DIFF_EQUAL,s.substring(0,e)]),i++),s=s.substring(e),a=a.substring(e)),0!==(e=this.diff_commonSuffix(s,a))&&(t[i][1]=s.substring(s.length-e)+t[i][1],s=s.substring(0,s.length-e),a=a.substring(0,a.length-e))),i-=n+r,t.splice(i,n+r),a.length&&(t.splice(i,0,[q.DIFF_DELETE,a]),i++),s.length&&(t.splice(i,0,[q.DIFF_INSERT,s]),i++),i++):0!==i&&t[i-1][0]===q.DIFF_EQUAL?(t[i-1][1]+=t[i][1],t.splice(i,1)):i++,r=0,n=0,a="",s=""}""===t[t.length-1][1]&&t.pop();var l=!1;for(i=1;i<t.length-1;)t[i-1][0]===q.DIFF_EQUAL&&t[i+1][0]===q.DIFF_EQUAL&&(t[i][1].substring(t[i][1].length-t[i-1][1].length)===t[i-1][1]?(t[i][1]=t[i-1][1]+t[i][1].substring(0,t[i][1].length-t[i-1][1].length),t[i+1][1]=t[i-1][1]+t[i+1][1],t.splice(i-1,1),l=!0):t[i][1].substring(0,t[i+1][1].length)===t[i+1][1]&&(t[i-1][1]+=t[i+1][1],t[i][1]=t[i][1].substring(t[i+1][1].length)+t[i+1][1],t.splice(i+1,1),l=!0)),i++;l&&this.diff_cleanupMerge(t)},t.prototype.diff_xIndex=function(t,e){var i,n=0,r=0,a=0,s=0;for(i=0;i<t.length&&(t[i][0]!==q.DIFF_INSERT&&(n+=t[i][1].length),t[i][0]!==q.DIFF_DELETE&&(r+=t[i][1].length),!(n>e));i++)a=n,s=r;return t.length!==i&&t[i][0]===q.DIFF_DELETE?s:s+(e-a)},t.prototype.diff_prettyHtml=function(t){for(var e=[],i=/&/g,n=/</g,r=/>/g,a=/\n/g,s=0;s<t.length;s++){var l=t[s][0],o=t[s][1].replace(i,"&amp;").replace(n,"&lt;").replace(r,"&gt;").replace(a,"&para;<br>");switch(l){case q.DIFF_INSERT:e[s]='<ins style="background:#e6ffe6;">'+o+"</ins>";break;case q.DIFF_DELETE:e[s]='<del style="background:#ffe6e6;">'+o+"</del>";break;case q.DIFF_EQUAL:e[s]="<span>"+o+"</span>"}}return e.join("")},t.prototype.diff_text1=function(t){for(var e=[],i=0;i<t.length;i++)t[i][0]!==q.DIFF_INSERT&&(e[i]=t[i][1]);return e.join("")},t.prototype.diff_text2=function(t){for(var e=[],i=0;i<t.length;i++)t[i][0]!==q.DIFF_DELETE&&(e[i]=t[i][1]);return e.join("")},t.prototype.diff_levenshtein=function(t){for(var e=0,i=0,n=0,r=0;r<t.length;r++){var a=t[r][0],s=t[r][1];switch(a){case q.DIFF_INSERT:i+=s.length;break;case q.DIFF_DELETE:n+=s.length;break;case q.DIFF_EQUAL:e+=J.max(i,n),i=0,n=0}}return e+=J.max(i,n)},t.prototype.diff_toDelta=function(t){for(var e=[],i=0;i<t.length;i++)switch(t[i][0]){case q.DIFF_INSERT:e[i]="+"+encodeURI(t[i][1]);break;case q.DIFF_DELETE:e[i]="-"+t[i][1].length;break;case q.DIFF_EQUAL:e[i]="="+t[i][1].length}return e.join("\t").replace(/%20/g," ")},t.prototype.diff_fromDelta=function(t,e){for(var i=[],n=0,r=0,a=e.split(/\t/g),s=0;s<a.length;s++){var l=a[s].substring(1);switch(a[s].charAt(0)){case"+":try{i[n++]=[q.DIFF_INSERT,decodeURI(l)]}catch(t){throw new Error("Illegal escape in diff_fromDelta: "+l)}break;case"-":case"=":var o=parseInt(l,10);if(isNaN(o)||o<0)throw new Error("Invalid number in diff_fromDelta: "+l);var d=t.substring(r,r+=o);"="===a[s].charAt(0)?i[n++]=[q.DIFF_EQUAL,d]:i[n++]=[q.DIFF_DELETE,d];break;default:if(a[s])throw new Error("Invalid diff operation in diff_fromDelta: "+a[s])}}if(r!==t.length)throw new Error("Delta length ("+r+") does not equal source text length ("+t.length+")");return i},t.prototype.match_main=function(t,e,i){if(null==t||null==e||null==i)throw new Error("Null input. (match_main)");return i=J.max(0,J.min(i,t.length)),t===e?0:t.length?t.substring(i,i+e.length)===e?i:this.match_bitap_(t,e,i):-1},t.prototype.patch_make=function(t,e,i){var n,r;if("string"==typeof t&&"string"==typeof e&&void 0===i)n=t,(r=this.diff_main(n,e,!0)).length>2&&(this.diff_cleanupSemantic(r),this.diff_cleanupEfficiency(r));else if(t&&"object"==typeof t&&void 0===e&&void 0===i)r=t,n=this.diff_text1(r);else if("string"==typeof t&&e&&"object"==typeof e&&void 0===i)n=t,r=e;else{if("string"!=typeof t||"string"!=typeof e||!i||"object"!=typeof i)throw new Error("Unknown call format to patch_make");n=t,r=i}if(0===r.length)return[];for(var a=[],s=new K,l=0,o=0,d=0,f=n,h=n,c=0;c<r.length;c++){var p=r[c][0],u=r[c][1];switch(l||p===q.DIFF_EQUAL||(s.start1=o,s.start2=d),p){case q.DIFF_INSERT:s.diffs[l++]=r[c],s.length2+=u.length,h=h.substring(0,d)+u+h.substring(d);break;case q.DIFF_DELETE:s.length1+=u.length,s.diffs[l++]=r[c],h=h.substring(0,d)+h.substring(d+u.length);break;case q.DIFF_EQUAL:u.length<=2*this.patchMargin&&l&&r.length!==c+1?(s.diffs[l++]=r[c],s.length1+=u.length,s.length2+=u.length):u.length>=2*this.patchMargin&&l&&(this.patch_addContext_(s,f),a.push(s),s=new K,l=0,f=h,o=d)}p!==q.DIFF_INSERT&&(o+=u.length),p!==q.DIFF_DELETE&&(d+=u.length)}return l&&(this.patch_addContext_(s,f),a.push(s)),a},t.prototype.patch_deepCopy=function(t){for(var e=[],i=0;i<t.length;i++){for(var n=t[i],r=new K,a=0;a<n.diffs.length;a++)r.diffs[a]=[n.diffs[a][0],n.diffs[a][1]];r.start1=n.start1,r.start2=n.start2,r.length1=n.length1,r.length2=n.length2,e[i]=r}return e},t.prototype.patch_apply=function(t,e){if(0===t.length)return[e,[]];t=this.patch_deepCopy(t);var i=this.patch_addPadding(t);e=i+e+i,this.patch_splitMax(t);for(var n=0,r=[],a=0;a<t.length;a++){var s=t[a].start2+n,l=this.diff_text1(t[a].diffs),o=void 0,d=-1;if(l.length>this.matchMaxBits?-1!==(o=this.match_main(e,l.substring(0,this.matchMaxBits),s))&&(-1===(d=this.match_main(e,l.substring(l.length-this.matchMaxBits),s+l.length-this.matchMaxBits))||o>=d)&&(o=-1):o=this.match_main(e,l,s),-1===o)r[a]=!1,n-=t[a].length2-t[a].length1;else{r[a]=!0,n=o-s;var f=void 0;if(l===(f=-1===d?e.substring(o,o+l.length):e.substring(o,d+this.matchMaxBits)))e=e.substring(0,o)+this.diff_text2(t[a].diffs)+e.substring(o+l.length);else{var h=this.diff_main(l,f,!1);if(l.length>this.matchMaxBits&&this.diff_levenshtein(h)/l.length>this.patchDeleteThreshold)r[a]=!1;else{this.diff_cleanupSemanticLossless(h);for(var c=0,p=0,u=0;u<t[a].diffs.length;u++){var g=t[a].diffs[u];g[0]!==q.DIFF_EQUAL&&(p=this.diff_xIndex(h,c)),g[0]===q.DIFF_INSERT?e=e.substring(0,o+p)+g[1]+e.substring(o+p):g[0]===q.DIFF_DELETE&&(e=e.substring(0,o+p)+e.substring(o+this.diff_xIndex(h,c+g[1].length))),g[0]!==q.DIFF_DELETE&&(c+=g[1].length)}}}}}return[e=e.substring(i.length,e.length-i.length),r]},t.prototype.patch_addPadding=function(t){for(var e=this.patchMargin,i="",n=1;n<=e;n++)i+=String.fromCharCode(n);for(n=0;n<t.length;n++)t[n].start1+=e,t[n].start2+=e;var r=t[0],a=r.diffs;if(0===a.length||a[0][0]!==q.DIFF_EQUAL)a.unshift([q.DIFF_EQUAL,i]),r.start1-=e,r.start2-=e,r.length1+=e,r.length2+=e;else if(e>a[0][1].length){var s=e-a[0][1].length;a[0][1]=i.substring(a[0][1].length)+a[0][1],r.start1-=s,r.start2-=s,r.length1+=s,r.length2+=s}if(0===(a=(r=t[t.length-1]).diffs).length||a[a.length-1][0]!==q.DIFF_EQUAL)a.push([q.DIFF_EQUAL,i]),r.length1+=e,r.length2+=e;else if(e>a[a.length-1][1].length){s=e-a[a.length-1][1].length;a[a.length-1][1]+=i.substring(0,s),r.length1+=s,r.length2+=s}return i},t.prototype.patch_splitMax=function(t){for(var e=this.matchMaxBits,i=0;i<t.length;i++)if(!(t[i].length1<=e)){var n=t[i];t.splice(i--,1);for(var r=n.start1,a=n.start2,s="";0!==n.diffs.length;){var l=new K,o=!0;for(l.start1=r-s.length,l.start2=a-s.length,""!==s&&(l.length1=l.length2=s.length,l.diffs.push([q.DIFF_EQUAL,s]));0!==n.diffs.length&&l.length1<e-this.patchMargin;){var d=n.diffs[0][0],f=n.diffs[0][1];d===q.DIFF_INSERT?(l.length2+=f.length,a+=f.length,l.diffs.push(n.diffs.shift()),o=!1):d===q.DIFF_DELETE&&1===l.diffs.length&&l.diffs[0][0]===q.DIFF_EQUAL&&f.length>2*e?(l.length1+=f.length,r+=f.length,o=!1,l.diffs.push([d,f]),n.diffs.shift()):(f=f.substring(0,e-l.length1-this.patchMargin),l.length1+=f.length,r+=f.length,d===q.DIFF_EQUAL?(l.length2+=f.length,a+=f.length):o=!1,l.diffs.push([d,f]),f===n.diffs[0][1]?n.diffs.shift():n.diffs[0][1]=n.diffs[0][1].substring(f.length))}s=(s=this.diff_text2(l.diffs)).substring(s.length-this.patchMargin);var h=this.diff_text1(n.diffs).substring(0,this.patchMargin);""!==h&&(l.length1+=h.length,l.length2+=h.length,0!==l.diffs.length&&l.diffs[l.diffs.length-1][0]===q.DIFF_EQUAL?l.diffs[l.diffs.length-1][1]+=h:l.diffs.push([q.DIFF_EQUAL,h])),o||t.splice(++i,0,l)}}},t.prototype.patch_toText=function(t){for(var e=[],i=0;i<t.length;i++)e[i]=t[i];return e.join("")},t.prototype.patch_fromText=function(t){var e=[];if(!t)return e;for(var i=t.split("\n"),n=0,r=/^@@ -(\d+),?(\d*) \+(\d+),?(\d*) @@$/;n<i.length;){var a=i[n].match(r);if(!a)throw new Error("Invalid patch string: "+i[n]);var s=new K;e.push(s),s.start1=parseInt(a[1],10),""===a[2]?(s.start1--,s.length1=1):"0"===a[2]?s.length1=0:(s.start1--,s.length1=parseInt(a[2],10)),s.start2=parseInt(a[3],10),""===a[4]?(s.start2--,s.length2=1):"0"===a[4]?s.length2=0:(s.start2--,s.length2=parseInt(a[4],10)),n++;for(var l=void 0,o=void 0,d=void 0;n<i.length;){l=i[n].charAt(0),d=i[n].substring(1);try{o=decodeURI(d)}catch(t){throw new Error("Illegal escape in patch_fromText: "+d)}if("-"===l)s.diffs.push([q.DIFF_DELETE,o]);else if("+"===l)s.diffs.push([q.DIFF_INSERT,o]);else if(" "===l)s.diffs.push([q.DIFF_EQUAL,o]);else{if("@"===l)break;if(""!==l)throw new Error('Invalid patch mode "'+l+'" in: '+o)}n++}}return e},t.prototype.diff_compute_=function(t,e,i,n){var r;if(!t)return[[q.DIFF_INSERT,e]];if(!e)return[[q.DIFF_DELETE,t]];var a=t.length>e.length?t:e,s=t.length>e.length?e:t,l=a.indexOf(s);if(-1!==l)return r=[[q.DIFF_INSERT,a.substring(0,l)],[q.DIFF_EQUAL,s],[q.DIFF_INSERT,a.substring(l+s.length)]],t.length>e.length&&(r[0][0]=q.DIFF_DELETE,r[2][0]=q.DIFF_DELETE),r;if(1===s.length)return[[q.DIFF_DELETE,t],[q.DIFF_INSERT,e]];var o=this.diff_halfMatch_(t,e);if(o){var d=o[0],f=o[1],h=o[2],c=o[3],p=o[4],u=this.diff_main(d,h,i,n),g=this.diff_main(f,c,i,n);return u.concat([[q.DIFF_EQUAL,p]],g)}return i&&t.length>100&&e.length>100?this.diff_lineMode_(t,e,n):this.diff_bisect_(t,e,n)},t.prototype.diff_lineMode_=function(t,e,i){var n=this.diff_linesToChars_(t,e);t=n.chars1,e=n.chars2;var r=n.lineArray,a=this.diff_main(t,e,!1,i);this.diff_charsToLines_(a,r),this.diff_cleanupSemantic(a),a.push([q.DIFF_EQUAL,""]);for(var s=0,l=0,o=0,d="",f="";s<a.length;){switch(a[s][0]){case q.DIFF_INSERT:o++,f+=a[s][1];break;case q.DIFF_DELETE:l++,d+=a[s][1];break;case q.DIFF_EQUAL:if(l>=1&&o>=1){a.splice(s-l-o,l+o),s=s-l-o;for(var h=this.diff_main(d,f,!1,i),c=h.length-1;c>=0;c--)a.splice(s,0,h[c]);s+=h.length}o=0,l=0,d="",f=""}s++}return a.pop(),a},t.prototype.diff_bisect_=function(t,e,i){for(var n=t.length,r=e.length,a=Math.ceil((n+r)/2),s=a,l=2*a,o=new Array(l),d=new Array(l),f=0;f<l;f++)o[f]=-1,d[f]=-1;o[s+1]=0,d[s+1]=0;for(var h=n-r,c=h%2!=0,p=0,u=0,g=0,m=0,v=0;v<a&&!(Date.now()>i);v++){for(var I=-v+p;I<=v-u;I+=2){for(var _=s+I,O=void 0,b=(O=I===-v||I!==v&&o[_-1]<o[_+1]?o[_+1]:o[_-1]+1)-I;O<n&&b<r&&t.charAt(O)===e.charAt(b);)O++,b++;if(o[_]=O,O>n)u+=2;else if(b>r)p+=2;else if(c){if((y=s+h-I)>=0&&y<l&&-1!==d[y])if(O>=(F=n-d[y]))return this.diff_bisectSplit_(t,e,O,b,i)}}for(var E=-v+g;E<=v-m;E+=2){for(var y=s+E,F=void 0,x=(F=E===-v||E!==v&&d[y-1]<d[y+1]?d[y+1]:d[y-1]+1)-E;F<n&&x<r&&t.charAt(n-F-1)===e.charAt(r-x-1);)F++,x++;if(d[y]=F,F>n)m+=2;else if(x>r)g+=2;else if(!c){if((_=s+h-E)>=0&&_<l&&-1!==o[_]){b=s+(O=o[_])-_;if(O>=(F=n-F))return this.diff_bisectSplit_(t,e,O,b,i)}}}}return[[q.DIFF_DELETE,t],[q.DIFF_INSERT,e]]},t.prototype.diff_bisectSplit_=function(t,e,i,n,r){var a=t.substring(0,i),s=e.substring(0,n),l=t.substring(i),o=e.substring(n),d=this.diff_main(a,s,!1,r),f=this.diff_main(l,o,!1,r);return d.concat(f)},t.prototype.diff_linesToChars_=function(t,e){var i=[],n={};return i[0]="",{chars1:this.diff_linesToCharsMunge_(t,i,n,4e4),chars2:this.diff_linesToCharsMunge_(e,i,n,65535),lineArray:i}},t.prototype.diff_linesToCharsMunge_=function(t,e,i,n){for(var r="",a=0,s=-1,l=e.length;s<t.length-1;){-1===(s=t.indexOf("\n",a))&&(s=t.length-1);var o=t.substring(a,s+1);(i.hasOwnProperty?i.hasOwnProperty(o):void 0!==i[o])?r+=String.fromCharCode(i[o]):(l===n&&(o=t.substring(a),s=t.length),r+=String.fromCharCode(l),i[o]=l,e[l++]=o),a=s+1}return r},t.prototype.diff_charsToLines_=function(t,e){for(var i=0;i<t.length;i++){for(var n=t[i][1],r=[],a=0;a<n.length;a++)r[a]=e[n.charCodeAt(a)];t[i][1]=r.join("")}},t.prototype.diff_commonOverlap_=function(t,e){var i=t.length,n=e.length;if(0===i||0===n)return 0;i>n?t=t.substring(i-n):i<n&&(e=e.substring(0,i));var r=J.min(i,n);if(t===e)return r;for(var a=0,s=1;;){var l=t.substring(r-s),o=e.indexOf(l);if(-1===o)return a;s+=o,0!==o&&t.substring(r-s)!==e.substring(0,s)||(a=s,s++)}},t.prototype.diff_halfMatch_=function(t,e){if(this.diffTimeout<=0)return null;var i=t.length>e.length?t:e,n=t.length>e.length?e:t;if(i.length<4||2*n.length<i.length)return null;var r,a,s,l,o,d=this.diff_halfMatchI_(i,n,Math.ceil(i.length/4)),f=this.diff_halfMatchI_(i,n,Math.ceil(i.length/2));if(!d&&!f)return null;var h=(r=f?d&&d[4].length>f[4].length?d:f:d)[4];return t.length>e.length?(a=r[0],s=r[1],l=r[2],o=r[3]):(l=r[0],o=r[1],a=r[2],s=r[3]),[a,s,l,o,h]},t.prototype.diff_halfMatchI_=function(t,e,i){for(var n,r,a,s,l=t.substring(i,i+Math.floor(t.length/4)),o="",d=e.indexOf(l,0);-1!==d;){var f=this.diff_commonPrefix(t.substring(i),e.substring(d)),h=this.diff_commonSuffix(t.substring(0,i),e.substring(0,d));o.length<h+f&&(o=e.substring(d-h,d)+e.substring(d,d+f),n=t.substring(0,i-h),r=t.substring(i+f),a=e.substring(0,d-h),s=e.substring(d+f)),d=e.indexOf(l,d+1)}return 2*o.length>=t.length?[n,r,a,s,o]:null},t.prototype.diff_cleanupSemanticScore_=function(t,e){if(!t||!e)return 6;var i=t.charAt(t.length-1),n=e.charAt(0),r=i.match(G),a=n.match(G),s=r&&i.match(H),l=a&&n.match(H),o=s&&i.match(V),d=l&&n.match(V),f=o&&t.match(X),h=d&&e.match(Z);return f||h?5:o||d?4:r&&!s&&l?3:s||l?2:r||a?1:0},t.prototype.match_bitap_=function(t,e,i){if(e.length>this.matchMaxBits)throw new Error("Pattern too long for this browser");var n=this.match_alphabet_(e),r=this.matchThreshold,a=t.indexOf(e,i);-1!==a&&(r=J.min(this.match_bitapScore_(0,a,e,i),r),-1!==(a=t.lastIndexOf(e,i+e.length))&&(r=J.min(this.match_bitapScore_(0,a,e,i),r)));var s,l,o=1<<e.length-1;a=-1;for(var d,f=e.length+t.length,h=0;h<e.length;h++){for(s=0,l=f;s<l;)this.match_bitapScore_(h,i+l,e,i)<=r?s=l:f=l,l=Math.floor((f-s)/2+s);f=l;var c=J.max(1,i-l+1),p=J.min(i+l,t.length)+e.length,u=Array(p+2);u[p+1]=(1<<h)-1;for(var g=p;g>=c;g--){var m=n[t.charAt(g-1)];if(u[g]=0===h?(u[g+1]<<1|1)&m:(u[g+1]<<1|1)&m|(d[g+1]|d[g])<<1|1|d[g+1],u[g]&o){var v=this.match_bitapScore_(h,g-1,e,i);if(v<=r){if(r=v,!((a=g-1)>i))break;c=J.max(1,2*i-a)}}}if(this.match_bitapScore_(h+1,i,e,i)>r)break;d=u}return a},t.prototype.match_bitapScore_=function(t,e,i,n){var r=t/i.length,a=Math.abs(n-e);return this.matchDistance?r+a/this.matchDistance:a?1:r},t.prototype.match_alphabet_=function(t){for(var e={},i=0;i<t.length;i++)e[t.charAt(i)]=0;for(i=0;i<t.length;i++)e[t.charAt(i)]|=1<<t.length-i-1;return e},t.prototype.patch_addContext_=function(t,e){if(0!==e.length){if(null==t.start2)throw Error("patch not initialized");for(var i=e.substring(t.start2,t.start2+t.length1),n=0;e.indexOf(i)!==e.lastIndexOf(i)&&i.length<this.matchMaxBits-this.patchMargin-this.patchMargin;)n+=this.patchMargin,i=e.substring(t.start2-n,t.start2+t.length1+n);n+=this.patchMargin;var r=e.substring(t.start2-n,t.start2);r&&t.diffs.unshift([q.DIFF_EQUAL,r]);var a=e.substring(t.start2+t.length1,t.start2+t.length1+n);a&&t.diffs.push([q.DIFF_EQUAL,a]),t.start1-=r.length,t.start2-=r.length,t.length1+=r.length+a.length,t.length2+=r.length+a.length}},t}();function Y(t,e,i,n,r){let a=R("\x02",t,0,0,t,0,e,i,r),s=R("\x03",t,1,1,t,0,e,i),l={};return l[i]=n,{userDictionary:l,segmentTreeRoot:function(...t){let e=new w(t.join("")),i=C(e);return e.matchEnd(),i}(a,s)}}function tt(t,e,i){Object.assign(t,i.userDictionary);let n=e;i.briefs.reduce((t,e)=>"\x01"===e.type?function(t,e){var i;let n=null!==(i=v(t,e.parentClientId,e.parentOrdinal))&&void 0!==i?i:I(t,e.parentClientId,e.parentOrdinal);if(!n)throw"Did not find the parent of patch insert brief.";et(n);let r=n.segment,a=void 0;if(void 0!==e.insertBeforeClientId&&void 0!==e.insertBeforeOrdinal){let t=v(r,e.insertBeforeClientId,e.insertBeforeOrdinal);if(void 0===t)throw"Expected to find the insert before reference when applying patch.";let i=t.segment;for(;void 0!==i;){if(i.parent===r){a=i;break}i=i.parent}}let s,l=a?a.previousSibling:r.lastChild;for(;l&&!(e.clientId>l.clientId||e.clientId===l.clientId&&e.firstOrdinal>l.firstOrdinal);)l=l.previousSibling;void 0!==l?(s={type:e.type,clientId:e.clientId,firstOrdinal:e.firstOrdinal,lastOrdinal:e.lastOrdinal,timestamp:e.timestamp,userId:e.userId,payload:e.payload,parent:r,firstChild:void 0,lastChild:void 0,previousSibling:l,nextSibling:l.nextSibling,modifiers:[]},void 0===s.nextSibling&&(r.lastChild=s),void 0!==l.nextSibling&&(l.nextSibling.previousSibling=s),l.nextSibling=s):(s={type:e.type,clientId:e.clientId,firstOrdinal:e.firstOrdinal,lastOrdinal:e.lastOrdinal,timestamp:e.timestamp,userId:e.userId,payload:e.payload,parent:r,firstChild:void 0,lastChild:void 0,previousSibling:void 0,nextSibling:r.firstChild,modifiers:[]},void 0!==r.firstChild&&(r.firstChild.previousSibling=s),r.firstChild=s,void 0===r.lastChild&&(r.lastChild=s));r.firstChild===s&&it(r)&&(s=r);return s}(t,e):function(t,e){var i;let n=e.parentOrdinal+e.firstOrdinal-e.lastOrdinal,r=e.parentOrdinal,a=null!==(i=v(t,e.parentClientId,n))&&void 0!==i?i:I(t,e.parentClientId,n);if(!a)throw"Did not find the first parent of modifier brief.";a=function(t){let e=m(t);if(void 0===e)throw"Expected to find a previous atom when splitting before.";et(e);let i=g(e);if(void 0===i)throw"There must be a next segment as we just split at this position.";return i}(a);let s=0,l=a.segment;for(;l;){let t=r>=l.firstOrdinal&&r<=l.lastOrdinal;t&&et({segment:l,ordinal:r});let i=void 0;for(let t=0;t<l.modifiers.length;t++){const n=l.modifiers[t];if(e.clientId<n.clientId||e.clientId===n.clientId&&e.firstOrdinal<n.firstOrdinal){i=t;break}}let a=l.lastOrdinal-l.firstOrdinal+1,o={type:e.type,clientId:e.clientId,firstOrdinal:e.lastOrdinal-s-a+1,lastOrdinal:e.lastOrdinal-s,timestamp:e.timestamp,userId:e.userId,payload:""};if(void 0===i?l.modifiers.push(o):l.modifiers.splice(i,0,o),s+=a,t)break;let d=v(l,e.parentClientId,n+s);if(void 0===d)throw"Didn't find next parent for modifier.";l=d.segment}return it(l),l}(t,e),n)}function et(t){let e=t.segment;if(t.ordinal<e.firstOrdinal||t.ordinal>e.lastOrdinal)throw"Invalid atom position";if(t.ordinal==e.lastOrdinal)return;let i=t.ordinal-e.firstOrdinal+1,n=e.lastOrdinal-t.ordinal,r=i,a={type:e.type,clientId:e.clientId,firstOrdinal:t.ordinal+1,lastOrdinal:e.lastOrdinal,timestamp:e.timestamp,userId:e.userId,payload:e.payload.slice(r),parent:e,firstChild:e.firstChild,lastChild:e.lastChild,nextSibling:void 0,previousSibling:void 0,modifiers:e.modifiers.map(t=>({type:t.type,clientId:t.clientId,firstOrdinal:t.firstOrdinal,lastOrdinal:t.firstOrdinal+n-1,timestamp:t.timestamp,userId:t.userId,payload:""}))},s=e.firstChild;for(;s;)s.parent=a,s=s.nextSibling;e.lastOrdinal=t.ordinal,e.payload=e.payload.slice(0,r),e.firstChild=a,e.lastChild=a,e.modifiers.forEach(t=>{t.firstOrdinal=t.lastOrdinal-i+1})}function it(t){let e=c(t);if(void 0===e)throw"Expected to find a next segment when joining.";if(t!==e.parent)return!1;if(t.clientId!==e.clientId)return!1;if(t.lastOrdinal+1!==e.firstOrdinal)return!1;if(void 0!==e.previousSibling||void 0!==e.nextSibling)return!1;if(t.timestamp!=e.timestamp)return!1;if(t.userId!=e.userId)return!1;if("\x01"!==t.type||"\x01"!==e.type)return!1;if(t.modifiers.length!==e.modifiers.length)return!1;for(let i=0;i<t.modifiers.length;i++){let n=t.modifiers[i],r=e.modifiers[i];if(n.clientId!==r.clientId)return!1;if(n.firstOrdinal-1!==r.lastOrdinal)return!1;if(n.timestamp!=r.timestamp)return!1;if(n.userId!=r.userId)return!1;if(n.type!=r.type)return!1}t.lastOrdinal=e.lastOrdinal,t.payload+=e.payload;for(let i=0;i<t.modifiers.length;i++)t.modifiers[i].firstOrdinal=e.modifiers[i].firstOrdinal;t.firstChild=e.firstChild,t.lastChild=e.lastChild;let i=e.firstChild;for(;i;)i.parent=t,i=i.nextSibling;return!0}function nt(t,e,i,n,r=!0){let a=j(t,void 0,e,i),s=new W;s.diffTimeout=1;let l=s.diff_main(a,n);r&&s.diff_cleanupSemantic(l);var o=e,d=[];for(const[t,e]of l)switch(t){case-1:let t=_(o,e.length);d.push({action:"deletion",from:o,to:t}),o=t;break;case 1:d.push({action:"insertion",at:o,text:e});break;default:o=_(o,e.length)}return d}class rt{constructor(t,e){rt.validateUserId(t),rt.validateTimestamp(e),this.externalUserId=t,this.userId=Q(),this.clientId=Q();let i=Q();this.weave=Y(this.clientId,e,this.userId,this.externalUserId,i),this.nextOrdinal=this.findNextOrdinal()}static load(t,e){var i;rt.validateUserId(t);let n=new rt(t,0);return n.weave=T(e),n.userId=null!==(i=Object.keys(n.weave.userDictionary).find(e=>n.weave.userDictionary[e]===t))&&void 0!==i?i:n.userId,n.nextOrdinal=n.findNextOrdinal(),n.previousReplace=void 0,n}save(){return S(this.weave)}replace(t,e,i,n,r=!1){t>e&&([t,e]=[e,t]),rt.validateTimestamp(n);let a,s,l=n;if(void 0!==this.previousReplace&&n<this.previousReplace.timestamp+10){let n=this.previousReplace.offsetLeft===this.previousReplace.offsetRight&&this.previousReplace.text.match(new RegExp("^(?:[\0-\ud7ff\ue000-\uffff]|[\ud800-\udbff][\udc00-\udfff])$")),r=t===e&&i.match(new RegExp("^(?:[\0-\ud7ff\ue000-\uffff]|[\ud800-\udbff][\udc00-\udfff])$")),a=t===this.previousReplace.offsetLeft+this.previousReplace.text.length,s=n&&r&&a,o=""===this.previousReplace.text&&(this.previousReplace.offsetLeft===this.previousReplace.offsetRight-1||this.previousReplace.offsetLeft===this.previousReplace.offsetRight-2),d=""===i&&(t===e-1||t===e-2),f=e===this.previousReplace.offsetLeft,h=o&&d&&f;(s||h)&&(l=this.previousReplace.burstTimestamp)}if(a=function(t,e){if(void 0!==t.parent)throw"Expected to get the root segment.";return _({segment:t,ordinal:t.firstOrdinal},e)}(this.weave.segmentTreeRoot,t),!a)throw`Expected to find offsetLeft within weave (${t}).`;if(s=_(a,e-t),!s)throw`Expected to find offsetRight within weave (${e}).`;let d=r?nt(this.weave.segmentTreeRoot,a,s,i):[{action:"insertion",at:a,text:i},{action:"deletion",from:a,to:s}];const{patch:f,nextOrdinal:p}=function(t,e,i,n,r,a){let s=[];for(const a of t)switch(a.action){case"insertion":if(""!==a.text){if(!new RegExp("^[^\0]*$").test(a.text))throw"Expected no null bytes.";let t=g(a.at);if(void 0===t)throw"Expected to find an atom to the right of insertion point.";s.push({insertBeforeClientId:t.segment.clientId,insertBeforeOrdinal:t.ordinal,type:"\x01",clientId:e,firstOrdinal:i,lastOrdinal:i+a.text.length-1,parentClientId:a.at.segment.clientId,parentOrdinal:a.at.ordinal,timestamp:n,userId:r,payload:a.text}),i+=a.text.length}break;case"deletion":if("\x03"===a.to.segment.type)throw"Right edge cannot be the end delimiter.";if(!h(a.from,a.to)){let t=[],l=g(a.from);if(void 0===l)throw"Expected to find an atom to the right of insertion point.";let d=a.to,f=l.segment;for(;f;){if(""!==o(f)){let e=f===l.segment?l.ordinal:f.firstOrdinal,n=f===d.segment?d.ordinal:f.lastOrdinal,r=n-e+1;t.push([f.clientId,n,r]),i+=r}if(f===d.segment)break;f=c(f)}let h=i-1;for(let i=0;i<t.length;i++){let[a,l,o]=t[i];s.push({type:"\x04",clientId:e,firstOrdinal:h-o+1,lastOrdinal:h,parentClientId:a,parentOrdinal:l,timestamp:n,userId:r,payload:""}),h-=o}}}let l={};return s.length>0&&(l[r]=a),{patch:{userDictionary:l,briefs:s},nextOrdinal:i}}(d,this.clientId,this.nextOrdinal,l,this.userId,this.externalUserId);return this.nextOrdinal=p,tt(this.weave.userDictionary,a.segment,f),this.previousReplace={offsetLeft:t,offsetRight:e,text:i,timestamp:n,burstTimestamp:l},A(f)}applyPatchReturnReplaceArguments(t){let e=P(this.weave.segmentTreeRoot);tt(this.weave.userDictionary,this.weave.segmentTreeRoot,t),this.previousReplace=void 0;let i,[n,r]=function(t,e){let i=void 0,n=void 0,r=void 0,a=void 0,s=t;for(;void 0!==s;){let t=void 0,l=void 0,o=e[s.clientId];(void 0===o||o<s.lastOrdinal)&&(t=Math.max(s.firstOrdinal,o+1),l=s.lastOrdinal),s.modifiers.forEach(i=>{let n=e[i.clientId];if(void 0===n||n<i.lastOrdinal){t=s.firstOrdinal;let e=void 0;e=void 0===n?s.lastOrdinal:Math.min(s.lastOrdinal,s.firstOrdinal+(i.lastOrdinal-n)-1),(void 0===l||e>l)&&(l=e)}}),void 0===n&&void 0!==t&&(i=s,n=t),void 0!==l&&(r=s,a=l),s=c(s)}if(void 0===i||void 0===n||void 0===r||void 0===a){let e={segment:t,ordinal:t.firstOrdinal};return[e,e]}let l=m({segment:i,ordinal:n});if(void 0===l)throw"Should never find a modified atom that doesn't at least has a start delimiter before.";return[l,{segment:r,ordinal:a}]}(this.weave.segmentTreeRoot,e),a=O(this.weave.segmentTreeRoot,n,e);return i=h(n,r)?a:O(this.weave.segmentTreeRoot,r,e),[a,i,j(this.weave.segmentTreeRoot,void 0,n,r)]}applyPatch(t){let e=L(t);return this.applyPatchReturnReplaceArguments(e)}undoRedoPatch(t,e,r){rt.validateTimestamp(r);let a=function(t,e,r,a,s,l,o){let d=e.briefs,f=[];for(let e=0;e<d.length;e++){const o=d[e];let h=o.lastOrdinal-o.firstOrdinal+1;"\x01"===o.type?f.push({type:"undo"===t?"\x06":"\x05",clientId:r,firstOrdinal:a,lastOrdinal:a+h-1,parentClientId:o.clientId,parentOrdinal:o.lastOrdinal,timestamp:s,userId:l,payload:""}):f.push({type:"undo"===t?i[o.type]:n[o.type],clientId:r,firstOrdinal:a,lastOrdinal:a+h-1,parentClientId:o.parentClientId,parentOrdinal:o.parentOrdinal,timestamp:s,userId:l,payload:""}),a+=h}let h={};return h[l]=o,{patch:{userDictionary:h,briefs:f},nextOrdinal:a}}(t,L(e),this.clientId,this.nextOrdinal,r,this.userId,this.externalUserId);this.nextOrdinal=a.nextOrdinal;let s=this.applyPatchReturnReplaceArguments(a.patch);return{patch:A(a.patch),replaceArguments:s}}undoPatch(t,e){return this.undoRedoPatch("undo",t,e)}redoPatch(t,e){return this.undoRedoPatch("redo",t,e)}merge(t){let e=function(t,e){var i;let n={},r=[],a=t.segmentTreeRoot;for(;void 0!==a;){if("\x02"===a.type||"\x03"===a.type){a=u(a);continue}let s=null!==(i=e[a.clientId])&&void 0!==i?i:-1;if(a.lastOrdinal>s){n[a.userId]=t.userDictionary[a.userId];let e=a.nextSibling;if(a.firstOrdinal>s)r.push({insertBeforeClientId:null==e?void 0:e.clientId,insertBeforeOrdinal:null==e?void 0:e.firstOrdinal,type:a.type,clientId:a.clientId,firstOrdinal:a.firstOrdinal,lastOrdinal:a.lastOrdinal,parentClientId:a.parent.clientId,parentOrdinal:a.parent.lastOrdinal,timestamp:a.timestamp,userId:a.userId,payload:a.payload});else{let t=s-a.firstOrdinal+1;r.push({insertBeforeClientId:null==e?void 0:e.clientId,insertBeforeOrdinal:null==e?void 0:e.firstOrdinal,type:a.type,clientId:a.clientId,firstOrdinal:s+1,lastOrdinal:a.lastOrdinal,parentClientId:a.clientId,parentOrdinal:s,timestamp:a.timestamp,userId:a.userId,payload:a.payload.slice(t)})}}a.modifiers.forEach(i=>{var l;s=null!==(l=e[i.clientId])&&void 0!==l?l:-1,i.lastOrdinal>s&&(n[i.userId]=t.userDictionary[i.userId],i.firstOrdinal>s?r.push({type:i.type,clientId:i.clientId,firstOrdinal:i.firstOrdinal,lastOrdinal:i.lastOrdinal,parentClientId:a.clientId,parentOrdinal:a.lastOrdinal,timestamp:i.timestamp,userId:i.userId,payload:i.payload}):r.push({type:i.type,clientId:i.clientId,firstOrdinal:Math.max(i.firstOrdinal,s+1),lastOrdinal:i.lastOrdinal,parentClientId:a.clientId,parentOrdinal:a.lastOrdinal-(s-i.firstOrdinal+1),timestamp:i.timestamp,userId:i.userId,payload:i.payload}))}),a=u(a)}return{userDictionary:n,briefs:r}}(T(t),P(this.weave.segmentTreeRoot));return this.applyPatchReturnReplaceArguments(e)}restore(t,e){rt.validateTimestamp(t),rt.validateTimestamp(e);let{patch:i,nextOrdinal:n}=function(t,e,i,n,r,a,s){e=Math.max(t.timestamp,e);let l=b(t,(t,s)=>{let l=0;s.timestamp>e&&(l+=1),s.modifiers.forEach(t=>{t.timestamp>e&&(l+="\x05"===t.type?1:-1)});let o=s.lastOrdinal-s.firstOrdinal+1;for(;0!==l;){let e=l>0?"\x06":"\x05";t.push({type:e,clientId:i,firstOrdinal:n,lastOrdinal:n+o-1,parentClientId:s.clientId,parentOrdinal:s.lastOrdinal,timestamp:r,userId:a,payload:""}),n+=o,l+=l>0?-1:1}return t},[]),o={};return l.length>0&&(o[a]=s),{patch:{userDictionary:o,briefs:l},nextOrdinal:n}}(this.weave.segmentTreeRoot,t,this.clientId,this.nextOrdinal,e,this.userId,this.externalUserId);this.nextOrdinal=n;let r=this.applyPatchReturnReplaceArguments(i);return{patch:A(i),replaceArguments:r}}text(t){return t=null!=t?t:l,rt.validateTimestamp(t),j(this.weave.segmentTreeRoot,t)}diff(t,e){return rt.validateTimestamp(t),rt.validateTimestamp(e),function(t,e,i){let n={fromTimestamp:e,toTimestamp:i,text:"",charactersAdded:0,charactersRemoved:0,changes:[]},r=0,a=void 0;return b(t.segmentTreeRoot,(n,s)=>{let l=B(s,e,i);if(void 0!==l){n.text+=s.payload;let e=s.payload.length;if("present"!==l){let[i,o]=l;"added"===i&&(n.charactersAdded+=s.lastOrdinal-s.firstOrdinal+1),"removed"===i&&(n.charactersRemoved+=s.lastOrdinal-s.firstOrdinal+1),o=t.userDictionary[o],void 0!==a&&a.change===i&&a.userId===o&&a.toOffset===r?a.toOffset+=e:(a={fromOffset:r,toOffset:r+e,change:i,userId:o},n.changes.push(a))}r+=e}return n},n),n}(this.weave,t,e)}edits(t,e,i){return e=null!=e?e:0,i=null!=i?i:l,rt.validateTimestamp(e),rt.validateTimestamp(i),function(t,e,i,n){let r=b(t.segmentTreeRoot,(t,e)=>("\x01"===e.type&&(e.timestamp>=i&&e.timestamp<=n&&t.push([e.timestamp,e]),e.modifiers.forEach(r=>{r.timestamp>=i&&r.timestamp<=n&&t.push([r.timestamp,e])})),t),[]);r.sort((t,e)=>t[0]-e[0]);let a,s=[],l=Number.MIN_SAFE_INTEGER;r.forEach(([t,i])=>{t>=l+e?(a={from:t,to:t,segments:(new Set).add(i)},s.push(a)):void 0!==a&&(a.to=t,a.segments.add(i)),l=t});let o=[];return s.forEach(e=>{let i=0,n=0,r=new Set;e.segments.forEach(a=>{let s=B(a,e.from,e.to);if(void 0!==s&&"present"!==s){let[e,l]=s;"added"===e&&(i+=a.lastOrdinal-a.firstOrdinal+1),"removed"===e&&(n+=a.lastOrdinal-a.firstOrdinal+1),r.add(t.userDictionary[l])}}),0!==r.size&&o.push({fromTimestamp:e.from,toTimestamp:e.to,charactersAdded:i,charactersRemoved:n,userIds:Array.from(r).sort()})}),o}(this.weave,t,e,i)}lengthStats(){return b(this.weave.segmentTreeRoot,(t,e)=>{let i=18*(1+e.modifiers.length)+e.payload.length+("\x01"===e.type?1:0);return t.weave+=i,"\x01"===e.type&&(""!==o(e)?(t.presentText+=e.payload.length,t.presentSegments+=i):(t.deletedText+=e.payload.length,t.deletedSegments+=i)),t},{presentText:0,deletedText:0,presentSegments:0,deletedSegments:0,weave:0})}asciiUserDictionary(){return t=this.weave.userDictionary,Object.keys(t).sort().reduce((e,i)=>e+`${i}: ${t[i]}\n`,"");var t}asciiTree(){return function(t){var e;let i=t,n=[],r=[];for(;i;){for(;0!==r.length&&r[r.length-1]!==i.parent;)r.pop();const t=r.length;z(n,i,null!==(e=i.parent)&&void 0!==e?e:i,t);for(let e=0;e<i.modifiers.length;e++){z(n,i.modifiers[e],i,t+1)}r.push(i),i=c(i)}return n.join("")}(this.weave.segmentTreeRoot)}static validateUserId(t){if(!new RegExp("^[^\0]{4,}$").test(t))throw"Expected an user id longer than four characters with no null bytes."}static validateTimestamp(t){if(!Number.isInteger(t)||t<0||t>l)throw`Expected timestamp to be an integer within range ([0, ${l}]).`}findNextOrdinal(){let t=P(this.weave.segmentTreeRoot)[this.clientId];return void 0===t?0:t+1}}t.OffsetClient=rt,Object.defineProperty(t,"__esModule",{value:!0})}));
